#!/bin/bash
# =============================================================================
# NaviX 应用部署脚本
# 用途：部署 NaviX 应用到服务器
# 用法：bash deploy-app.sh
# =============================================================================

set -e

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# =============================================================================
# 配置变量
# =============================================================================
APP_USER="navix"
APP_DIR="/var/www/navix"
REPO_URL="https://github.com/your-org/navix.git"  # 修改为你的仓库
BRANCH="main"

# =============================================================================
# 检查运行用户
# =============================================================================
CURRENT_USER=$(whoami)
if [ "$CURRENT_USER" != "$APP_USER" ] && [ "$CURRENT_USER" != "root" ]; then
    log_error "请使用 ${APP_USER} 或 root 用户运行"
    exit 1
fi

# 如果是 root，切换到应用用户
if [ "$CURRENT_USER" == "root" ]; then
    log_info "切换到用户 ${APP_USER} 执行..."
    exec su - $APP_USER -c "bash $0 $@"
fi

log_info "开始部署 NaviX..."

# =============================================================================
# 1. 进入应用目录
# =============================================================================
cd $APP_DIR
log_info "1/7 进入目录 ${APP_DIR}"

# =============================================================================
# 2. 拉取最新代码
# =============================================================================
log_info "2/7 拉取最新代码..."
if [ -d ".git" ]; then
    git fetch origin
    git reset --hard origin/$BRANCH
    log_info "代码更新完成"
else
    log_warn "非 Git 仓库，跳过代码更新"
fi

# =============================================================================
# 3. 检查环境变量
# =============================================================================
log_info "3/7 检查环境配置..."
if [ ! -f ".env.local" ]; then
    log_error "未找到 .env.local 文件！"
    log_error "请创建 .env.local 并配置必要的环境变量"
    echo ""
    echo "必需的环境变量："
    echo "  OPENAI_API_KEY=xxx"
    echo "  ANTHROPIC_API_KEY=xxx"
    echo "  TAVILY_API_KEY=xxx"
    echo ""
    exit 1
fi
log_info ".env.local 文件存在"

# =============================================================================
# 4. 安装依赖
# =============================================================================
log_info "4/7 安装 Node.js 依赖..."
npm ci --production=false
log_info "依赖安装完成"

# =============================================================================
# 5. 构建应用
# =============================================================================
log_info "5/7 构建应用..."
npm run build
log_info "构建完成"

# =============================================================================
# 6. 复制 favicon 到 public
# =============================================================================
log_info "6/7 处理静态资源..."
if [ -f "app/favicon.ico" ] && [ ! -f "public/favicon.ico" ]; then
    cp app/favicon.ico public/favicon.ico
    log_info "favicon.ico 已复制到 public 目录"
fi

# =============================================================================
# 7. 重启服务
# =============================================================================
log_info "7/7 重启服务..."

# 检查 PM2 是否已有该应用
if pm2 list | grep -q "navix"; then
    pm2 restart navix
    log_info "NaviX 服务已重启"
else
    pm2 start npm --name "navix" -- start
    pm2 save
    log_info "NaviX 服务已启动"
fi

# =============================================================================
# 完成
# =============================================================================
echo ""
echo "=============================================="
log_info "部署完成！"
echo "=============================================="
pm2 list
echo ""
echo "查看日志: pm2 logs navix"
echo "监控状态: pm2 monit"
echo "=============================================="
